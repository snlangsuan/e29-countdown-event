(window.webpackJsonp=window.webpackJsonp||[]).push([[28,15],{501:function(t,e,n){var content=n(509);content.__esModule&&(content=content.default),"string"==typeof content&&(content=[[t.i,content,""]]),content.locals&&(t.exports=content.locals);(0,n(25).default)("6b258f3f",content,!0,{sourceMap:!1})},508:function(t,e,n){"use strict";n(501)},509:function(t,e,n){var o=n(24)(!1);o.push([t.i,"@import url(https://fonts.googleapis.com/css2?family=Kanit:wght@100;300;400;500;600;700&display=swap);"]),o.push([t.i,'.slot-machine__container[data-v-6d29407f]{width:100%;padding:16px 16px 8px;border-radius:4px}.slot-machine-list[data-v-6d29407f]{position:relative;width:100%;display:flex}.slot-machine-list[data-v-6d29407f],.slot-machine-list *[data-v-6d29407f]{-webkit-user-select:none;-moz-user-select:none;user-select:none}.slot-machine-item[data-v-6d29407f]{border-radius:4px;overflow:hidden;background-color:#fff}.slot-machine-list>.slot-machine-item+.slot-machine-item[data-v-6d29407f]{margin-left:8px}.slot-machine-boxes[data-v-6d29407f]{width:200px;height:200px;overflow:hidden}.slot-machine-box[data-v-6d29407f]{display:block;margin:0;padding:12px 0}.slot-machine-box__item[data-v-6d29407f]{display:flex;justify-content:center;align-items:center;font-size:8rem;font-size:Roboto,"sans-serif";margin-left:-2px}.slot-machine-details[data-v-6d29407f]{margin-top:16px;font-size:5rem;text-align:center}',""]),t.exports=o},513:function(t,e,n){"use strict";n.r(e);n(182);var o=n(75),r=(n(55),n(74),n(3),n(10),{name:"SlotMachine",props:{message:{type:String,default:""},hideDetails:{type:Boolean,default:!1},fixed:{type:Boolean,default:!1},messageColor:{type:String,default:"#000000"},color:{type:String,default:"#000000"},slotBackground:{type:String,default:"#ffffff"},backgroundColor:{type:String,default:"#ffffff00"}},data:function(){return{id:null,ro:null,boxSize:200,boxPadding:12,slots:[],opts:null,startedAt:null,visible:!1}},mounted:function(){var t=this;this.id="slot-machine-"+this._uid,this.ro=new ResizeObserver(this.onResize),this.initSlots(),this.loadEffect(),setTimeout((function(){t.ro.observe(t.$refs[t.id]),t.onResize()}),100)},beforeDestroy:function(){this.ro.unobserve(this.$refs[this.id])},methods:{onResize:function(){var t=this.$refs[this.id].offsetWidth;console.log(t);var e=(t-72)/10;this.boxSize=e,this.boxPadding=.1*e,console.log(this.boxSize)},initSlots:function(){this.slots=Object(o.a)(Array(10)).map((function(t){return Object(o.a)(Array(11)).map((function(t,i){return i>9?"X":i}))}))},loadEffect:function(){this.audio=new Audio("/sounds/spinning-eff.mp3?d="+Date.now()),this.audio.preload="auto"},next:function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){setTimeout(t,1e3/60)}},start:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.opts||10!==e.length||(this.visible=!1,this.opts=this.slots.map((function(data,i){var slot=t.$refs.slots[i],n=e[i];return{el:slot.querySelector(".slot-machine-box"),finalPos:n*t.boxSize,startOffset:2e3+500*Math.random()+500*i,height:data.length*t.boxSize,duration:9e3+700*i,isFinished:!1}})),this.audio&&this.audio.play(),this.next()(this.animate))},reset:function(){for(var i in this.visible=!1,this.opts=null,this.startedAt=null,this.audio&&(this.audio.currentTime=0),this.slots){this.$refs.slots[i].querySelector(".slot-machine-box").style.transform="translateY(0)"}},show:function(t){for(var i in this.visible=!0,this.slots){var e=t[i],data=this.slots[i],slot=this.$refs.slots[i],n=e*this.boxSize,o=data.length*this.boxSize,r=-1*Math.floor(n%o);slot.querySelector(".slot-machine-box").style.transform="translateY("+r+"px)"}},animate:function(t){null===this.startedAt&&(this.startedAt=t);var e=t-this.startedAt;this.opts.forEach((function(t){if(!t.isFinished){var n=Math.max(t.duration-e,0),o=Math.pow(n,3)/Math.pow(t.duration,3)*t.startOffset,r=-1*Math.floor((o+t.finalPos)%t.height);t.el.style.transform="translateY("+r+"px)",e>t.duration&&(console.log("finished",t,r,t.finalPost),t.isFinished=!0)}})),this.opts.every((function(t){return t.isFinished}))?(this.opts=null,this.startedAt=null,this.audio&&this.audio.pause(),this.audio&&(this.audio.currentTime=0),this.visible=!0,console.log("finished")):this.next()(this.animate)}}}),l=r,c=(n(508),n(63)),component=Object(c.a)(l,(function(){var t=this,e=t._self._c;return e("div",{ref:t.id,staticClass:"slot-machine__container",style:{backgroundColor:t.backgroundColor}},[e("div",{staticClass:"slot-machine-list"},[t._l(t.slots,(function(slot,i){return[e("div",{key:"slot-"+i,ref:"slots",refInFor:!0,staticClass:"slot-machine-item",style:{backgroundColor:t.slotBackground}},[e("div",{staticClass:"slot-machine-boxes",style:{width:t.boxSize+2*t.boxPadding+"px",height:t.boxSize+2*t.boxPadding+"px"}},[e("div",{staticClass:"slot-machine-box",style:{paddingTop:t.boxPadding+"px",paddingBottom:t.boxPadding+"px"}},[t._l(slot,(function(n,o){return[e("div",{key:"item-"+i+o,staticClass:"slot-machine-box__item",style:{width:t.boxSize+"px",height:t.boxSize+"px",fontSize:t.boxSize+"px"}},[t._v("\n                "+t._s(n)+"\n              ")])]})),t._v(" "),e("div",{staticClass:"slot-machine-box__item slot-machine-box__item--copy",style:{width:t.boxSize+"px",height:t.boxSize+"px",fontSize:t.boxSize+"px"}},[t._v("\n              "+t._s(slot[0])+"\n            ")])],2)])])]}))],2),t._v(" "),t.hideDetails?t._e():e("div",{staticClass:"slot-machine-details",style:{minHeight:.7*t.boxSize+"px",fontSize:.7*t.boxSize+"px",color:t.messageColor}},[t._v("\n    "+t._s(t.visible||t.fixed?t.message:" ")+"\n  ")])])}),[],!1,null,"6d29407f",null);e.default=component.exports},584:function(t,e,n){"use strict";t.exports=function(t,e){return e||(e={}),"string"!=typeof(t=t&&t.__esModule?t.default:t)?t:(/^['"].*['"]$/.test(t)&&(t=t.slice(1,-1)),e.hash&&(t+=e.hash),/["'() \t\n]/.test(t)||e.needQuotes?'"'.concat(t.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):t)}},585:function(t,e,n){t.exports=n.p+"img/stage-btn.5961cfb.png"},596:function(t,e,n){var content=n(653);content.__esModule&&(content=content.default),"string"==typeof content&&(content=[[t.i,content,""]]),content.locals&&(t.exports=content.locals);(0,n(25).default)("0e9e80ba",content,!0,{sourceMap:!1})},652:function(t,e,n){"use strict";n(596)},653:function(t,e,n){var o=n(24),r=n(584),l=n(585),c=o(!1);c.push([t.i,"@import url(https://fonts.googleapis.com/css2?family=Kanit:wght@100;300;400;500;600;700&display=swap);"]);var d=r(l);c.push([t.i,".screen__container[data-v-7fe03a9c]{height:100%;margin:auto;background-repeat:no-repeat;background-size:cover;overflow:auto}.screen__wrapper[data-v-7fe03a9c]{background-color:#ddd;background-repeat:no-repeat;background-size:cover;background-position:50%;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;border:thin solid #fafafa;cursor:none;overflow:hidden}.screen__wrapper[data-v-7fe03a9c],.screen__wrapper *[data-v-7fe03a9c]{-webkit-user-select:none;-moz-user-select:none;user-select:none}.screen-device[data-v-7fe03a9c]{position:fixed;bottom:8px;right:16px;text-align:right;font-size:.6rem;color:#ddd}.screen-item[data-v-7fe03a9c]{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center}.screen-winner[data-v-7fe03a9c]{margin-top:16px}.screen-winner--text[data-v-7fe03a9c]{font-size:5rem}.screen-btn[data-v-7fe03a9c]{width:200px;height:200px;background-image:url("+d+");background-position:50%;background-repeat:no-repeat;background-size:contain;box-sizing:border-box;cursor:pointer;-webkit-user-select:none;-webkit-touch-callout:none;-moz-user-select:none;user-select:none}.screen-btn[data-v-7fe03a9c]:disabled{cursor:not-allowed;filter:grayscale(100%)}.screen-mode-btn[data-v-7fe03a9c]{width:100px;height:100px;background-color:#fff;border:thin solid #ddd;border-radius:4px;margin-left:auto;margin-right:auto;cursor:pointer;-webkit-user-select:none;-webkit-touch-callout:none;-moz-user-select:none;user-select:none}.screen-mode-btn[data-v-7fe03a9c]:disabled{cursor:not-allowed;filter:grayscale(100%)}",""]),t.exports=c},697:function(t,e,n){"use strict";n.r(e);n(28),n(41),n(9),n(17),n(10),n(18);var o=n(75),r=n(15),l=n(2),c=(n(51),n(74),n(12),n(31),n(43),n(30),n(11),n(3),n(56),n(183)),d=n.n(c);function f(object,t){var e=Object.keys(object);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(object);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(object,t).enumerable}))),e.push.apply(e,n)}return e}function h(t){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?f(Object(source),!0).forEach((function(e){Object(l.a)(t,e,source[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(source)):f(Object(source)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(source,e))}))}return t}var m={name:"StageMainPage",layout:"empty",middleware:"auth",data:function(){return{state:"wait",spinning:!0,showWinner:!1,isSpinDevice:!1,hasRegistrants:!1,slotLen:10,buttonSize:100,backgroundImage:null,winner:{name:"",telno:""},error:{show:!1,messages:[]},settings:{width:1280,height:720,background:{url:null,image:null,path:null,mode:"color",color:"#DDDDDD"},button:{size:180,padding_top:32,padding_bottom:32,background:{url:null,image:null,path:null}},slot:{width:1240,name_color:"#000000",number_color:"#000000",number_background:"#ffffff",background_color:"#ffffff00"}},winners:[]}},computed:{screenStyle:function(){var t="color"===this.settings.background.mode?{backgroundColor:this.settings.background.color}:{backgroundImage:"url("+this.settings.background.url+")"};return h({width:this.settings.width+"px",height:this.settings.height+"px"},t)},slotStyle:function(){return{width:this.settings.slot.width+"px"}},screenButtonStyle:function(){return{paddingTop:this.settings.button.padding_top+"px",paddingBottom:this.settings.button.padding_bottom+"px"}},buttonStyle:function(){return{width:this.settings.button.size+"px",height:this.settings.button.size+"px",backgroundImage:"url("+this.settings.button.background.url+")",backgroundColor:this.settings.button.background.url?"transparent":"#ffffff"}}},mounted:function(){this.init(),this.initEvent()},methods:{onResize:function(){var t=window.innerHeight;this.buttonSize=.25*t},init:function(){try{var t=this.loadRegistrants();console.log(t),this.hasRegistrants=t&&t.length>0}catch(t){this.error.messages=[t.message],this.error.show=!1}},initEvent:function(){var t=this;this.$fire.database.ref("stage").on("value",(function(e){var n=e.val();if(t.onOffloadRegistrants(n.offline_version),!t.isSpinDevice){t.state=n.state;var o=n.winner;t.winner=o,console.log(t.state),"spinning"===t.state?t.onSpinning():"spined"===t.state&&(t.onSpined(),t.showWinner=!0)}"0000000000"===t.winner.telno&&(t.$refs.slot_machine&&t.$refs.slot_machine.reset(),t.showWinner=!1)})),this.$fire.database.ref("winner_logs").on("value",(function(e){var n=e.val()||{};t.winners=Object.keys(n).map((function(t){return n[t].telno}))})),this.$fire.database.ref("settings/stages/main").on("value",this.loadSettings)},loadSettings:function(t){try{var e=t.val()||{};this.settings.width=e.width||1280,this.settings.height=e.height||720;var n=e.background||{};this.settings.background.mode=n.mode||"color",this.settings.background.color=n.color||"#DDDDDD",this.settings.background.url=n.url||null,this.settings.background.path=n.path||null,this.settings.background.image=null;var button=e.button||{};this.settings.button.size=button.size||180,this.settings.button.padding_top=button.padding_top||32,this.settings.button.padding_bottom=button.padding_bottom||32;var o=button.background||{};this.settings.button.background.url=o.url||null,this.settings.button.background.path=o.path||null,this.settings.button.background.image=null;var slot=e.slot||{};this.settings.slot.width=slot.width||1240,this.settings.slot.name_color=slot.name_color||"#000000",this.settings.slot.number_color=slot.number_color||"#000000",this.settings.slot.number_background=slot.number_background||"#ffffff",this.settings.slot.background_color=slot.background_color||"#ffffff00"}catch(t){console.error(t)}},handleOnSpin:function(){var t=this;return Object(r.a)(regeneratorRuntime.mark((function e(){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t.showWinner=!1,t.isSpinDevice=!0,t.spinning=!1,(n=t.getWinner()).telno){e.next=7;break}return e.abrupt("return");case 7:return t.winner=n,e.next=10,t.$fire.database.ref("stage").update({winner:n,state:"spinning"});case 10:return t.state="spinning",e.next=13,t.onSpinning();case 13:return e.next=15,t.$fire.database.ref("stage").update({state:"spined"});case 15:return e.next=17,t.$fire.database.ref("winner_logs").push(h(h({},n),{},{created_at:d()().format("YYYY-MM-DD HH:mm:ss")}));case 17:t.state="spined",e.next=23;break;case 20:e.prev=20,e.t0=e.catch(0),console.error(e.t0);case 23:return e.prev=23,t.showWinner=!0,t.spinning=!1,t.isSpinDevice=!1,e.finish(23);case 28:case"end":return e.stop()}}),e,null,[[0,20,23,28]])})))()},onSpinning:function(){var t=this;return Object(r.a)(regeneratorRuntime.mark((function e(){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[].concat(Object(o.a)(t.winner.telno.slice(0,-3).split("").map((function(t){return Number(t)}))),[10,10,10]),t.$refs.slot_machine&&t.$refs.slot_machine.reset(),e.next=4,t.$refs.slot_machine.start(n);case 4:case"end":return e.stop()}}),e)})))()},onSpined:function(){var t=this;return Object(r.a)(regeneratorRuntime.mark((function e(){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[].concat(Object(o.a)(t.winner.telno.slice(0,-3).split("").map((function(t){return Number(t)}))),[10,10,10]),console.log(t.$refs.slot_machine),t.$refs.slot_machine&&t.$refs.slot_machine.reset(),e.next=5,t.$refs.slot_machine.show(n);case 5:case"end":return e.stop()}}),e)})))()},getWinner:function(){var t=this;try{var e=this.loadRegistrants();e=e.filter((function(e){return!t.winners.includes(e.telno)})),console.log("before get winner",e.length);var n=e[Math.floor(Math.random()*e.length)],filter=e.filter((function(t){return t.telno!==n.telno}));return this.hasRegistrants=filter&&filter.length>0,n}catch(t){console.error(t)}},onOffloadRegistrants:function(t){var e=this;return Object(r.a)(regeneratorRuntime.mark((function n(){var o,r,l,c;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,o=localStorage.getItem("offline_version"),r=localStorage.getItem("offline_registrants"),console.log("load registrants",t,o),o===t+""&&r){n.next=12;break}return n.next=7,e.$fire.database.ref("candidates").once("value");case 7:l=n.sent,c=l.val()||"[]",localStorage.setItem("offline_registrants",JSON.stringify(c)),localStorage.setItem("offline_version",t),e.hasRegistrants=c&&c.length>0;case 12:n.next=19;break;case 14:n.prev=14,n.t0=n.catch(0),console.error(n.t0),localStorage.removeItem("offline_registrants"),e.hasRegistrants=!1;case 19:case"end":return n.stop()}}),n,null,[[0,14]])})))()},loadRegistrants:function(){try{return JSON.parse(localStorage.getItem("offline_registrants")||"[]")}catch(t){return[]}}}},v=(n(652),n(63)),component=Object(v.a)(m,(function(){var t=this,e=t._self._c;return e("div",{staticClass:"screen__container"},[e("div",{staticClass:"screen__wrapper",style:t.screenStyle},[e("div",{staticClass:"screen__slot",style:t.slotStyle},[e("slot-machine",{ref:"slot_machine",attrs:{items:t.slotLen,message:"คุณ"+t.winner.name,visible:t.showWinner,"message-color":t.settings.slot.name_color,color:t.settings.slot.number_color,"slot-background":t.settings.slot.number_background,"background-color":t.settings.slot.background_color}})],1),t._v(" "),e("div",{staticClass:"screen__button",style:t.screenButtonStyle},[e("button",{staticClass:"screen-btn",style:t.buttonStyle,attrs:{disabled:!t.hasRegistrants||["wait","spined","spinning"].includes(t.state)},on:{click:t.handleOnSpin}})])])])}),[],!1,null,"7fe03a9c",null);e.default=component.exports;installComponents(component,{SlotMachine:n(513).default})}}]);